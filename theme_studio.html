<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>VISUALIZER: STUDIO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;900&display=swap');

        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Montserrat', sans-serif; cursor: pointer; }
        
        #result-ui { position: absolute; width: 100%; height: 100%; z-index: 50; pointer-events: none; opacity: 0; transition: opacity 1s; }
        .vibe-badge { position: absolute; bottom: 40px; left: 40px; color: #fff; font-size: 3em; font-weight: 900; mix-blend-mode: screen; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .vibe-sub { font-size: 14px; display: block; margin-top: 5px; opacity: 0.8; letter-spacing: 2px; }
        
        .music-stats { position: absolute; bottom: 130px; left: 45px; text-align: left; font-family: 'Courier New', monospace; }
        .stat-row { margin-bottom: 6px; color: rgba(255, 255, 255, 0.6); font-size: 12px; letter-spacing: 1px; }
        .stat-value { color: #00dbde; font-weight: bold; font-size: 14px; margin-left: 10px; }

        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; transition: opacity 0.5s;
        }
        .start-title { color: #fff; font-size: 40px; font-weight: 900; letter-spacing: 5px; margin-bottom: 10px; }
        .start-sub { color: #00dbde; font-size: 14px; letter-spacing: 2px; animation: blink 1.5s infinite; margin-bottom: 30px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .option-container { display: flex; align-items: center; gap: 10px; pointer-events: auto; }
        .option-label { color: #888; font-size: 12px; letter-spacing: 1px; transition: 0.3s; }
        input[type="checkbox"] { accent-color: #00dbde; cursor: pointer; width: 16px; height: 16px; }
        input[type="checkbox"]:checked + .option-label { color: #00dbde; font-weight: bold; }

        #audio-player { display: none; }
    </style>
</head>
<body>
    <div id="start-overlay" onclick="startExperience()">
        <div class="start-title">MUSIC STUDIO</div>
        <div class="start-sub">CLICK TO START</div>

        <div class="option-container" onclick="event.stopPropagation()">
            <input type="checkbox" id="show-info-check">
            <label for="show-info-check" class="option-label">SHOW MUSIC INFO</label>
        </div>
    </div>

    <video id="bg-video" loop muted playsinline style="display:none;"></video>
    
    <audio id="audio-player" crossorigin="anonymous" src="./music_project/test.mp3" loop></audio>

    <div id="result-ui">
        <div id="music-stats-container" class="music-stats"></div>
        <div id="vibe-display" class="vibe-badge"></div>
    </div>

    <script>
        // ============================================================
        // ★ 0. 초기 설정 및 헬퍼 함수
        // ============================================================
        const EXCLUDED_IDS = [ 
            'midi_controller', 'Mixing_Desk', 'speaker1', 'speaker2', 
            'energy_drink1', 'energy_drink2', 'energy_drink3', 
            'monitor1', 'gameboy', 'nintendo', 'camara', 'whiteboard', 'Headphone' 
        ];

        const audioPlayer = document.getElementById('audio-player');
        const bgVideo = document.getElementById('bg-video');
        const startOverlay = document.getElementById('start-overlay');
        const resultUi = document.getElementById('result-ui');
        const infoCheckbox = document.getElementById('show-info-check');
        
        let isPlaying = false;

        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.01, 1000);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
        dirLight.position.set(5, 8, 5);
        dirLight.castShadow = true; 
        dirLight.shadow.mapSize.width = 2048; 
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); 
        scene.add(ambientLight);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; 
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        renderer.outputEncoding = THREE.sRGBEncoding; 
        renderer.toneMapping = THREE.ACESFilmicToneMapping; 
        renderer.toneMappingExposure = 1.0; 
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enabled = false; 

        const floorMat = new THREE.MeshStandardMaterial({ color: 0xA0522D, roughness: 0.7, metalness: 0.1 });
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(20, 20), floorMat);
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') window.location.href = 'index.html'; 
        });

        const listener = new THREE.AudioListener();
        camera.add(listener);
        const sound = new THREE.Audio(listener);
        let analyser = null;

        audioPlayer.onplay = () => {
            const context = listener.context;
            if (context.state === 'suspended') context.resume();
            if (!sound.source) {
                const source = context.createMediaElementSource(audioPlayer);
                sound.setNodeSource(source);
                analyser = new THREE.AudioAnalyser(sound, 128);
            }
        };

        // ============================================================
        // ★ 1. 데이터 로드 및 다이나믹 로직 적용
        // ============================================================
        let rawData = JSON.parse(localStorage.getItem('visualData'));
        
        let aiData = {
            bpm: 120, energy: 50, brightness: 50, topGenre: "Unknown", probability: 0
        };

        let colorPalette = [new THREE.Color("#00dbde"), new THREE.Color("#ff00de")];

        if (rawData) {
            aiData.bpm = rawData.bpm !== undefined ? rawData.bpm : 120;
            aiData.energy = rawData.energy !== undefined ? rawData.energy : 50;
            aiData.brightness = rawData.brightness !== undefined ? rawData.brightness : 50;
            aiData.topGenre = rawData.topGenre || "Unknown";
            aiData.probability = rawData.probability !== undefined ? rawData.probability : 0;

            if (rawData.audioUrl) {
                audioPlayer.src = rawData.audioUrl;
            }

            // 초민감 다이나믹 색상 생성
            let h1 = Math.floor((aiData.bpm * 4.3 + aiData.energy * 2.8 + aiData.brightness * 3.1) % 360);
            let h2 = Math.floor((h1 + 120) % 360);
            let h3 = Math.floor((h1 + 240) % 360);
            
            let s = Math.floor(75 + (aiData.energy % 25));
            let l = Math.floor(50 + (aiData.brightness % 15));

            colorPalette = [
                new THREE.Color(hslToHex(h1, s, l)),
                new THREE.Color(hslToHex(h2, s, l)),
                new THREE.Color(hslToHex(h3, s, l))
            ];

            aiData.mainColor = hslToHex(h1, s, l);
        } else {
            aiData.mainColor = "#00dbde";
        }

        document.getElementById('vibe-display').innerHTML = `${aiData.topGenre.toUpperCase()}<span class="vibe-sub">CONFIDENCE: ${aiData.probability.toFixed(1)}%</span>`; 
        document.getElementById('music-stats-container').innerHTML = `
            <div class="stat-row">TEMPO <span class="stat-value">${aiData.bpm.toFixed(0)} BPM</span></div>
            <div class="stat-row">ENERGY <span class="stat-value">${aiData.energy.toFixed(0)} %</span></div>
            <div class="stat-row">THEME <span class="stat-value" style="color:${aiData.mainColor}">${aiData.mainColor}</span></div>
        `;

        // ============================================================
        // ★ 2. 시작 로직
        // ============================================================
        function startExperience() {
            startOverlay.style.opacity = '0';
            setTimeout(() => { startOverlay.style.display = 'none'; }, 500);
            
            if (infoCheckbox.checked) resultUi.style.opacity = '1';
            else resultUi.style.opacity = '0';

            audioPlayer.play().then(() => {
                isPlaying = true;
            }).catch(e => {
                isPlaying = true;
            });

            if (bgVideo.src) {
                bgVideo.play().catch(e => console.log("Video autoplay blocked:", e));
            }
        }

        const vizCanvas = document.createElement('canvas');
        vizCanvas.width = 1024; vizCanvas.height = 512;
        const ctx = vizCanvas.getContext('2d');
        const vizTexture = new THREE.CanvasTexture(vizCanvas);

        function drawScreen() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 1024, 512);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 40px Courier New'; 
            ctx.textAlign = 'center';
            ctx.fillText("MUSIC STUDIO", 512, 240);
            ctx.font = '20px Courier New'; 
            ctx.fillStyle = aiData.mainColor;
            ctx.fillText("NOW PLAYING", 512, 290);
            vizTexture.needsUpdate = true;
        }
        drawScreen();

        // ============================================================
        // ★ 3. 3D 에셋 배치
        // ============================================================
        const THEME_CONFIG = {
          "desk": { "pos": { "x": 5.77, "y": 0, "z": -8.31 }, "rotDeg": 270, "scale": 2.6, "color": "#303030" },
          "Mixing_Desk": { "pos": { "x": 5.1, "y": 2.7, "z": -7.9 }, "rotDeg": 180, "scale": 0.6, "color": "#eeeeee" },
          "standing_desk": { "pos": { "x": 2, "y": 1, "z": -7.6 }, "rotDeg": 90, "scale": 2.6, "color": "#303030" },
          "standing_desk2": { "pos": { "x": 2, "y": 1, "z": -4.62 }, "rotDeg": 90, "scale": 2.6, "color": "#303030" },
          "speaker1": { "pos": { "x": 7.45, "y": 2.45, "z": -8.65 }, "rotDeg": 323, "scale": 1, "color": "#eeeeee" },
          "speaker2": { "pos": { "x": 2.09, "y": 2.45, "z": -8.65 }, "rotDeg": 36, "scale": 1, "color": "#eeeeee" },
          "gameboy": { "pos": { "x": 7.04, "y": 2.78, "z": -7.8 }, "rotDeg": 220, "scale": 0.5, "color": "#eeeeee" },
          "Headphone": { "pos": { "x": 7.12, "y": 2.53, "z": -6.43 }, "rotDeg": 281, "scale": 2, "color": "#eeeeee" },
          "wall2": { "pos": { "x": 8.5, "y": 0, "z": -2.5 }, "rotDeg": 0, "scale": 3, "color": "#ccad7f" },
          "wall1": { "pos": { "x": 8.5, "y": 0, "z": -8.5 }, "rotDeg": 0, "scale": 3, "color": "#ccad7f" },
          "wall4": { "pos": { "x": 10.13, "y": 0, "z": -9.85 }, "rotDeg": 90, "scale": 3, "color": "#ccad7f" },
          "wall3": { "pos": { "x": 8.5, "y": 0, "z": -5.5 }, "rotDeg": 0, "scale": 3, "color": "#ccad7f" },
          "midi_controller": { "pos": { "x": 1.97, "y": 2.46, "z": -5.92 }, "rotDeg": 90, "scale": 0.03, "color": "#eeeeee" },
          "wall_low": { "pos": { "x": 5.77, "y": -1.98, "z": -9.85 }, "rotDeg": 90, "scale": 3, "color": "#ccad7f" },
          "wall5": { "pos": { "x": -0.8, "y": 0, "z": -9.85 }, "rotDeg": 90, "scale": 3, "color": "#ccad7f" },
          "wall_low3": { "pos": { "x": 5.77, "y": 6.24, "z": -9.85 }, "rotDeg": 90, "scale": 3, "color": "#ccad7f" },
          "monitor1": { "pos": { "x": 4.9, "y": 2.45, "z": -8.98 }, "rotDeg": 0, "scale": 5, "color": "#eeeeee" },
          "nintendo": { "pos": { "x": 7.81, "y": 2.45, "z": -7.45 }, "rotDeg": 45, "scale": 0.01, "color": "#eeeeee" },
          "camara": { "pos": { "x": 2.08, "y": 4.14, "z": -8.65 }, "rotDeg": 9, "scale": 0.13, "color": "#eeeeee" },
          "whiteboard": { "pos": { "x": 8.36, "y": 3.72, "z": -7.3 }, "rotDeg": 180, "scale": 1.08, "color": "#eeeeee" },
          "wall_low2": { "pos": { "x": 0, "y": -1.98, "z": -9.85 }, "rotDeg": 90, "scale": 3, "color": "#ccad7f" },
          "wall_window": { "pos": { "x": 4.65, "y": 1.55, "z": -9.8 }, "rotDeg": 90, "scale": 2, "color": "#eeeeee" },
          "wall_low4": { "pos": { "x": 0.07, "y": 6.24, "z": -9.85 }, "rotDeg": 270, "scale": 3, "color": "#ccad7f" },
          "energy_drink2": { "pos": { "x": 7.5, "y": 4.55, "z": -8.9 }, "rotDeg": 217, "scale": 0.2, "color": "#eeeeee" },
          "energy_drink1": { "pos": { "x": 7.5, "y": 4.55, "z": -8.4 }, "rotDeg": 217, "scale": 0.2, "color": "#eeeeee" },
          "energy_drink3": { "pos": { "x": 7.1, "y": 4.55, "z": -8.65 }, "rotDeg": 217, "scale": 0.2, "color": "#eeeeee" },
          "backdrop": { "pos": { "x": 3.96, "y": 4.5, "z": -19.56 }, "scale": { "x": 16, "y": 9 }, "imageData": null, "videoData": null },
          "camera": { "pos": { "x": 4.811322916769001, "y": 4.1003138237776495, "z": -3.6476561144672974 }, "target": { "x": 5.723421122771882, "y": 3.2003816434043144, "z": -10.970304568444874 } }
        };

        const assetList = [
            { id: 'wall1',  file: './Household Props 001-glb/Wall Half.glb' },
            { id: 'wall2',  file: './Household Props 001-glb/Wall Half.glb' },
            { id: 'wall3',  file: './Household Props 001-glb/Wall Half.glb' },
            { id: 'wall4',  file: './Household Props 001-glb/Wall Half.glb' },
            { id: 'wall5',  file: './Household Props 001-glb/Wall Half.glb' },
            { id: 'wall_window',  file: './Household Props 001-glb/Wall Window Wide.glb' },
            { id: 'wall_low',  file: './Household Props 001-glb/Wall Low.glb' },
            { id: 'wall_low2',  file: './Household Props 001-glb/Wall Low.glb' },
            { id: 'wall_low3',  file: './Household Props 001-glb/Wall Low.glb' },
            { id: 'wall_low4',  file: './Household Props 001-glb/Wall Low.glb' },
            { id: 'desk', file: './Household Props 001-glb/Adjustable Desk.glb' },
            { id: 'standing_desk', file: './Household Props 001-glb/Standing Desk.glb' },
            { id: 'standing_desk2', file: './Household Props 001-glb/Standing Desk.glb' },
            { id: 'midi_controller', file: './Household Props 001-glb/MIDI Controller.glb' },
            { id: 'Mixing_Desk', file: './Household Props 001-glb/Digital Audio Mixing Desk.glb' },
            { id: 'speaker1', file: './Household Props 001-glb/Speaker.glb' },
            { id: 'speaker2', file: './Household Props 001-glb/Speaker.glb' },
            { id: 'energy_drink1', file: './Household Props 001-glb/Poly Energy.glb' },
            { id: 'energy_drink2', file: './Household Props 001-glb/Poly Energy.glb' },
            { id: 'energy_drink3', file: './Household Props 001-glb/Poly Energy.glb' },
            { id: 'monitor1', file: './Household Props 001-glb/Monitor.glb' }, 
            { id: 'gameboy', file: './Household Props 001-glb/Gameboy.glb' },
            { id: 'nintendo', file: './Household Props 001-glb/Handheld videogame console.glb' },
            { id: 'camara', file: './Household Props 001-glb/Camera.glb' },
            { id: 'whiteboard', file: './Household Props 001-glb/Whiteboard.glb' },
            { id: 'Headphone', file: './Household Props 001-glb/Headphones And iPod.glb' }
        ];

        const camConfig = THEME_CONFIG.camera;
        camera.position.set(camConfig.pos.x, camConfig.pos.y, camConfig.pos.z);
        controls.target.set(camConfig.target.x, camConfig.target.y, camConfig.target.z);
        controls.update();

        const loader = new THREE.GLTFLoader();
        assetList.forEach((item) => {
            if (!THEME_CONFIG[item.id]) return;
            loader.load(item.file, (gltf) => {
                const model = gltf.scene;
                const config = THEME_CONFIG[item.id];
                model.position.set(config.pos.x, config.pos.y, config.pos.z);
                model.rotation.y = THREE.MathUtils.degToRad(config.rotDeg);
                model.scale.set(config.scale, config.scale, config.scale);

                model.traverse(o => {
                    if (o.isMesh) {
                        o.castShadow = true; o.receiveShadow = true;
                        
                        if (item.id === 'monitor1') {
                            o.material = new THREE.MeshBasicMaterial({ map: vizTexture, toneMapped: false });
                            return; 
                        }
                        if (item.id === 'wall_window') {
                            const isGlass = o.material.name.toLowerCase().includes('glass') || o.material.name.toLowerCase().includes('window');
                            if (isGlass) {
                                o.material.transparent = true; o.material.opacity = 0.3;
                                o.material.color.set(0xffffff);
                            } else { o.material.color.set(config.color || "#eeeeee"); }
                            return;
                        }
                        if (config.color && !EXCLUDED_IDS.includes(item.id)) {
                            o.material = new THREE.MeshStandardMaterial({ color: config.color, roughness: 0.8, metalness: 0.0 });
                        }
                    }
                });
                scene.add(model);
            });
        });

        // ============================================================
        // ★ 4. 배경 비디오 맵핑 (다이나믹 시스템 적용)
        // ============================================================
        if (THEME_CONFIG.backdrop) {
            const bgConfig = THEME_CONFIG.backdrop;
            const bgGeo = new THREE.PlaneGeometry(1, 1);
            const bgMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
            const backdrop = new THREE.Mesh(bgGeo, bgMat);
            backdrop.position.set(bgConfig.pos.x, bgConfig.pos.y, bgConfig.pos.z);
            backdrop.scale.set(bgConfig.scale.x, bgConfig.scale.y, 1);
            
            // 여러 수치를 조합해 0~100점 사이의 배경 점수를 만듭니다.
            const bgScore = (aiData.bpm * 0.4 + aiData.energy * 0.3 + aiData.brightness * 0.3) % 100;
            
            let targetUrl = "./wallpaper/Night.mp4"; 

            if (bgScore >= 75) {
                targetUrl = "./wallpaper/Sunny.mp4"; 
            } else if (bgScore >= 50) {
                targetUrl = "./wallpaper/Sunset.mp4"; 
            } else if (bgScore >= 25) {
                targetUrl = "./wallpaper/Rainy.mp4"; 
            } else {
                targetUrl = "./wallpaper/Night.mp4"; 
            }

            console.log(`배경 결정 점수: ${bgScore.toFixed(2)}, 선택된 배경: ${targetUrl}`);

            bgVideo.src = targetUrl;
            const videoTexture = new THREE.VideoTexture(bgVideo);
            videoTexture.encoding = THREE.sRGBEncoding;
            backdrop.material.map = videoTexture;
            backdrop.material.needsUpdate = true;
            scene.add(backdrop);
        }

        // ============================================================
        // ★ 5. 애니메이션 루프
        // ============================================================
        const clock = new THREE.Clock();
        const cycleSpeed = (aiData.bpm / 100) * 0.3; 

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            const cycleIndex = Math.floor(time * cycleSpeed) % colorPalette.length;
            const nextCycleIndex = (cycleIndex + 1) % colorPalette.length;
            const alpha = (time * cycleSpeed) % 1; 

            const currentColor = new THREE.Color();
            currentColor.copy(colorPalette[cycleIndex]).lerp(colorPalette[nextCycleIndex], alpha);

            dirLight.color.copy(currentColor);
            ambientLight.color.copy(currentColor);

            let beatIntensity = 0;
            if (isPlaying && analyser) {
                beatIntensity = analyser.getAverageFrequency() / 255.0;
            }

            const baseBrightness = 0.5 + (aiData.brightness / 200);
            dirLight.intensity = baseBrightness + (beatIntensity * 2.0);
            ambientLight.intensity = (baseBrightness * 0.5) + (beatIntensity * 0.8);

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>